# Deployment Guide - KTPM E-commerce Application

## 1. CI/CD Pipeline Đã Được Thiết Lập ✅

### 1.1 GitHub Actions Workflows

Dự án đã có 3 workflows tự động:

1. **CI Pipeline** (`.github/workflows/ci.yml`)
   - **Trigger**: Push vào `main`, `develop`, `feature/**`, `Manh_JOB`; Pull Request vào `main`/`develop`
   - **Jobs**:
     - Code quality checks (lint, security audit)
     - Backend tests với MongoDB service
     - Frontend tests
     - Docker build & push to GitHub Container Registry

2. **Comprehensive Testing** (`.github/workflows/test.yml`)
   - **Trigger**: Hàng ngày lúc 2 AM hoặc manual dispatch
   - **Jobs**: Extended test suite với coverage reports

3. **Staging Deployment** (`.github/workflows/deploy-staging.yml`)
   - **Trigger**: Push vào `develop` hoặc `feature/testing-setup` (hoặc chạy tay via "Run workflow")
   - **Jobs**: Deploy to Railway, health checks, smoke tests

### 1.2 CI/CD Workflow

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Git Push      │───▶│ GitHub Actions  │───▶│  Docker Build   │
│  (Code Change)  │    │   (Auto Run)    │    │   & Push GHCR   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Pre-commit     │    │   Run Tests     │    │    Deploy       │
│  (Prettier)     │    │  + Coverage     │    │   (Staging)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.3 Environments Đã Setup

- ✅ **Development**: Local với Docker Compose
- ✅ **CI/CD Testing**: GitHub Actions
- ⚠️ **Staging**: Cần cấu hình Railway secrets
- ⏳ **Production**: Manual deployment (hướng dẫn bên dưới)

## 2. Sử Dụng CI/CD Đã Thiết Lập

### 2.1 Workflow Cơ Bản

**Bước 1: Làm việc với code**

```bash
# Tạo branch mới từ main
git checkout main
git pull origin main
git checkout -b feature/your-feature-name

# Viết code và commit
git add .
git commit -m "feat: your feature description"
# Pre-commit hook sẽ tự động format code với Prettier
```

**Bước 2: Push và tạo Pull Request**

```bash
# Push lên GitHub
git push origin feature/your-feature-name

# Tạo Pull Request trên GitHub
# CI Pipeline sẽ tự động chạy:
# - Code quality checks
# - Backend tests
# - Frontend tests
# - Docker build
```

**Bước 3: Xem kết quả CI**

```
# Vào GitHub Repository
https://github.com/phucmanh1310/CNPM/actions

# Hoặc trong Pull Request, scroll xuống xem "Checks"
# ✅ code-quality
# ✅ backend-tests
# ✅ frontend-tests
# ✅ build-images
```

**Bước 4: Merge vào main/develop**

```bash
# Sau khi PR được approve và CI pass
# Merge vào develop (hoặc push trực tiếp vào feature/testing-setup khi thử nghiệm)
# Deploy-staging workflow sẽ tự động chạy nếu branch là develop hoặc feature/testing-setup
```

### 2.2 Chạy Tests Local Trước Khi Push

```bash
# Chạy lint
npm run lint

# Fix lint errors tự động
npm run lint:fix

# Chạy tests
npm test

# Chạy tests với coverage
npm run test:coverage

# Test với Docker (giống CI environment)
npm run docker:test
```

### 2.3 Xem Coverage Reports

```bash
# Sau khi chạy tests với coverage
# Backend coverage
open BackEnd/coverage/index.html

# Frontend coverage
open FrontEnd/coverage/index.html

# Hoặc xem trên GitHub Actions
# Vào workflow run > backend-tests hoặc frontend-tests
# Xem coverage summary trong logs
```

### 2.4 Manual Trigger Workflows

```bash
# Trigger comprehensive testing workflow manually
# 1. Vào GitHub > Actions tab
# 2. Chọn "Comprehensive Testing"
# 3. Click "Run workflow" > chọn branch > "Run workflow"
```

### 2.5 Xem Docker Images

```bash
# Images được tự động build và push vào GitHub Container Registry
# Xem tại:
https://github.com/phucmanh1310?tab=packages

# Hoặc pull về local
docker pull ghcr.io/phucmanh1310/cnpm-backend:latest
docker pull ghcr.io/phucmanh1310/cnpm-frontend:latest
```

## 2. Prerequisites

## 3. Local Development (Đã Setup)

### 2.1 Required Tools

### 3.1 Tools Đã Cài Đặt

```bash
# Docker và Docker Compose
docker --version
docker-compose --version

# Node.js và npm
node --version
npm --version

# Git
git --version
```

### 3.2 Development Commands

```bash
# Chạy development (cả backend và frontend)
npm run dev

# Chạy riêng backend
npm run dev:backend

# Chạy riêng frontend
npm run dev:frontend

# Chạy tests
npm test

# Lint code
npm run lint

# Fix lint errors
npm run lint:fix
```

### 3.3 Start với Docker Compose

```bash
# Build và start tất cả services
docker-compose up --build

# Chạy ở background
docker-compose up -d

# Xem logs
docker-compose logs -f

# Stop services
docker-compose down

# Test với Docker (giống CI environment)
docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit
```

### 3.4 Verify Local Setup

```bash
# Backend health check
curl http://localhost:8000/health

# Access application
# Frontend
open http://localhost:5173

# Backend API
curl http://localhost:8000/api/health
```

## 4. GitHub Secrets Configuration

### 4.1 Required Secrets (Đã Thêm ✅)

Các secrets sau đã được thêm vào GitHub:

```
✅ MONGO_URI
✅ JWT_SECRET
✅ CLOUDINARY_CLOUD_NAME
✅ CLOUDINARY_API_KEY
✅ CLOUDINARY_API_SECRET
✅ EMAIL_USER
✅ EMAIL_PASS
✅ MOMO_ACCESS_KEY
✅ MOMO_PARTNER_CODE
✅ MOMO_SECRET_KEY
```

### 4.2 Secrets Cho Staging/Production (Cần Thêm)

Để enable staging deployment, cần thêm:

```bash
# Vào GitHub > Settings > Secrets and variables > Actions
# Thêm các secrets sau:

RAILWAY_TOKEN=<your-railway-token>
STAGING_URL=<your-staging-url>
```

#### Cách lấy Railway Token:

```bash
# 1. Install Railway CLI
npm install -g @railway/cli

# 2. Login
railway login

# 3. Get token
railway whoami
# Copy token từ ~/.railway/config.json
```

## 5. Branch Protection Rules (Recommended)

### 5.1 Setup Protection Cho Main Branch

```bash
# Vào GitHub > Settings > Branches
# Add protection rule cho 'main' branch:

✅ Require pull request reviews before merging
✅ Require status checks to pass before merging
   - code-quality
   - backend-tests
   - frontend-tests
   - build-images
✅ Require branches to be up to date before merging
✅ Include administrators
```

### 5.2 Workflow Với Branch Protection

```bash
# 1. Tạo feature branch
git checkout -b feature/new-feature

# 2. Commit changes
git commit -m "feat: new feature"

# 3. Push
git push origin feature/new-feature

# 4. Tạo PR trên GitHub
# 5. Đợi CI pass (tất cả checks phải green)
# 6. Request review
# 7. Sau khi approve, merge vào main
```

## 6. Staging Deployment

### 4.1 GitHub Actions Setup

### 6.1 Auto-Deploy Workflow (Đã Setup ✅)

```bash
# Workflow deploy-staging.yml sẽ tự động chạy khi:
# - Push vào develop branch
# - Hoặc manual trigger

# Các bước workflow thực hiện:
# 1. Deploy to Railway
# 2. Wait 30s
# 3. Health check
# 4. Run smoke tests
```

### 4.2 Railway Deployment

### 6.2 Manual Deploy to Railway

```bash
# Đã có Railway CLI
railway --version

# Login
railway login

# Link project
railway link

# Deploy
railway up

# Deploy specific service
railway up --service backend
railway up --service frontend
```

### 6.3 Monitor Staging

```bash
# Xem logs
railway logs

# Check status
railway status

# Open in browser
railway open
```

## 7. Production Deployment Options

### 7.1 Option 1: Railway (Recommended cho nhỏ)

```bash
# Tạo production environment trên Railway
# 1. Vào Railway dashboard
# 2. Tạo new environment: "production"
# 3. Deploy từ main branch

# Deploy to production
railway up --environment production
```

### 7.2 Option 2: Vercel (Frontend) + Railway (Backend)

```bash
# Frontend to Vercel
cd FrontEnd
npx vercel --prod

# Backend to Railway
cd ../BackEnd
railway up --service backend --environment production
```

### 7.3 Option 3: Docker Compose trên VPS

```bash
# 1. SSH vào VPS
ssh user@your-vps-ip

# 2. Clone repository
git clone https://github.com/phucmanh1310/CNPM.git
cd CNPM

# 3. Setup environment
cp BackEnd/.env.example BackEnd/.env
# Cập nhật production values

# 4. Run with Docker Compose
docker-compose up -d

# 5. Setup Nginx reverse proxy
# (xem section 8 bên dưới)
```

### 7.4 Option 4: Kubernetes (Cho scale lớn)

```bash
# Sử dụng manifest files đã có trong hướng dẫn
# (xem section 5.2 trong version cũ)
```

## 8. Nginx Reverse Proxy (VPS Deployment)

### 5.1 AWS ECS Deployment

### 8.1 Install Nginx

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# Start Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 8.2 Configure Nginx

```bash
# Tạo config file
sudo nano /etc/nginx/sites-available/ktpm

# Thêm nội dung:
```

```nginx
# Backend API
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# Frontend
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location / {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# Enable site
sudo ln -s /etc/nginx/sites-available/ktpm /etc/nginx/sites-enabled/

# Test config
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx
```

### 8.3 SSL với Let's Encrypt

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com -d api.yourdomain.com

# Auto-renewal
sudo certbot renew --dry-run
```

## 9. Monitoring & Debugging

#### 5.1.1 ECS Task Definition

### 9.1 GitHub Actions Logs

```bash
# Vào GitHub Actions
https://github.com/phucmanh1310/CNPM/actions

# Click vào workflow run
# Click vào failed job để xem logs
# Download logs nếu cần
```

### 9.2 Local Docker Debugging

```bash
# Xem logs
docker-compose logs -f backend
docker-compose logs -f frontend

# Exec vào container
docker-compose exec backend sh
docker-compose exec frontend sh

# Xem resource usage
docker stats
```

### 9.3 Application Health Checks

```bash
# Backend health
curl http://localhost:8000/health

# Detailed health
curl http://localhost:8000/health/detailed

# Test API endpoint
curl http://localhost:8000/api/items
```

### 9.4 Common Issues & Solutions

**Issue: CI fails vì lint errors**

```bash
# Fix locally
npm run lint:fix
git add .
git commit -m "fix: lint errors"
git push
```

**Issue: Tests fail locally nhưng pass trên CI**

```bash
# Chạy tests trong Docker environment giống CI
npm run docker:test
```

**Issue: Docker build fails**

```bash
# Build locally để debug
docker build -t test-backend ./BackEnd
docker build -t test-frontend ./FrontEnd
```

**Issue: Pre-commit hook fails**

```bash
# Skip hook tạm thời (không khuyến khích)
git commit --no-verify -m "message"

# Hoặc fix prettier issues
npx prettier --write .
```

## 10. Best Practices

### 10.1 Development Workflow

1. ✅ Luôn tạo feature branch từ `develop`
2. ✅ Commit messages theo format: `feat:`, `fix:`, `docs:`, `test:`
3. ✅ Chạy tests local trước khi push
4. ✅ Tạo PR và đợi CI pass
5. ✅ Request review từ team members
6. ✅ Merge sau khi approve và CI green

### 10.2 Code Quality

1. ✅ Pre-commit hook tự động format code
2. ✅ CI tự động check lint
3. ✅ Coverage thresholds enforced
4. ✅ Security audit trên dependencies

### 10.3 Testing

1. ✅ Unit tests cho tất cả controllers và utils
2. ✅ Integration tests cho API endpoints
3. ✅ Coverage reports upload to Codecov
4. ✅ Docker-based testing giống production

### 10.4 Security

1. ✅ Secrets stored trong GitHub Actions
2. ✅ Environment variables trong .env (không commit)
3. ✅ Security audit trong CI pipeline
4. ✅ HTTPS/SSL cho production

## 11. Quick Reference

### 11.1 NPM Scripts (Root)

```bash
npm run dev              # Dev: cả backend và frontend
npm run dev:backend      # Dev: backend only
npm run dev:frontend     # Dev: frontend only
npm test                 # Run all tests
npm run test:coverage    # Tests với coverage
npm run lint             # Lint all code
npm run lint:fix         # Auto-fix lint errors
npm run docker:dev       # Docker Compose dev
npm run docker:test      # Docker Compose test
```

### 11.2 Important URLs

```
GitHub Repository:  https://github.com/phucmanh1310/CNPM
GitHub Actions:     https://github.com/phucmanh1310/CNPM/actions
GitHub Packages:    https://github.com/phucmanh1310?tab=packages

Local Frontend:     http://localhost:5173
Local Backend:      http://localhost:8000
Backend Health:     http://localhost:8000/health
```

### 11.3 Git Workflow Commands

```bash
# Start new feature
git checkout develop
git pull origin develop
git checkout -b feature/feature-name

# Commit changes
git add .
git commit -m "feat: description"

# Push and create PR
git push origin feature/feature-name

# After PR merged, cleanup
git checkout develop
git pull origin develop
git branch -d feature/feature-name
```

## 12. Support & Resources

### 12.1 Documentation

- `CI_CD_SETUP_SUMMARY.md` - Tóm tắt CI/CD setup
- `4.CI_CD_IMPLEMENTATION_GUIDE.md` - Chi tiết implementation
- `2.UNIT_TESTING_GUIDE.md` - Unit testing guide
- `3.INTEGRATION_TESTING_GUIDE.md` - Integration testing guide

### 12.2 External Resources

- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Docker Documentation](https://docs.docker.com/)
- [Railway Documentation](https://docs.railway.app/)
- [Jest Documentation](https://jestjs.io/)
- [Vitest Documentation](https://vitest.dev/)

---

**Note**: File này tập trung vào hướng dẫn sử dụng CI/CD đã được thiết lập. Để biết chi tiết về cách thiết lập từ đầu, xem `4.CI_CD_IMPLEMENTATION_GUIDE.md`.

````

## 8. Monitoring Setup

### 8.1 Prometheus và Grafana

```bash
# Install using Helm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Install Prometheus
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace

# Access Grafana
kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80
````

## 9. Backup Strategy

### 9.1 Database Backup

```bash
# MongoDB backup script
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mongodump --uri="$MONGO_URI" --out="/backups/mongodb_$DATE"
aws s3 cp "/backups/mongodb_$DATE" "s3://your-backup-bucket/mongodb/" --recursive
```

### 9.2 Application Backup

```bash
# Backup application data
kubectl create backup ktpm-backup --include-namespaces=ktpm-production
```

## 10. Rollback Procedures

### 10.1 Kubernetes Rollback

```bash
# Check deployment history
kubectl rollout history deployment/ktpm-backend -n ktpm-production

# Rollback to previous version
kubectl rollout undo deployment/ktpm-backend -n ktpm-production

# Rollback to specific revision
kubectl rollout undo deployment/ktpm-backend --to-revision=2 -n ktpm-production
```

### 10.2 Database Rollback

```bash
# Restore from backup
mongorestore --uri="$MONGO_URI" --drop /path/to/backup
```

## 11. Troubleshooting

### 11.1 Common Issues

- **Container won't start**: Check logs với `docker logs` hoặc `kubectl logs`
- **Database connection**: Verify connection string và network policies
- **High memory usage**: Check for memory leaks, adjust resource limits
- **Slow response**: Check database queries, add indexes

### 11.2 Debug Commands

```bash
# Check pod status
kubectl get pods -n ktpm-production

# Get pod logs
kubectl logs -f deployment/ktpm-backend -n ktpm-production

# Execute into pod
kubectl exec -it pod-name -n ktpm-production -- /bin/bash

# Check resource usage
kubectl top pods -n ktpm-production
```
